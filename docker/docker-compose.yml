# Polymarket AutoTrader - Docker Compose Configuration
#
# This file orchestrates all services for the trading bot:
# - Main trading bot
# - Telegram notification bot (optional)
# - Dashboard (optional)
#
# Usage:
#   docker-compose up -d              # Start all services
#   docker-compose up -d bot          # Start only the bot
#   docker-compose logs -f bot        # Follow bot logs
#   docker-compose down               # Stop all services

version: '3.8'

services:
  # ===========================================================================
  # Main Trading Bot
  # ===========================================================================
  bot:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: polymarket-bot
    restart: unless-stopped
    
    # Environment from .env file
    env_file:
      - ../.env
    
    # Additional environment variables
    environment:
      - TZ=UTC
      - PYTHONUNBUFFERED=1
    
    # Persistent volumes for state and data
    volumes:
      - bot-state:/app/state
      - bot-logs:/app/logs
      - bot-simulation:/app/simulation
      # Optional: Mount .env for runtime config changes
      # - ../.env:/app/.env:ro
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    
    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('https://data-api.polymarket.com', timeout=5)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    
    # Network
    networks:
      - polymarket-net

  # ===========================================================================
  # Telegram Bot (Optional)
  # ===========================================================================
  telegram:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: polymarket-telegram
    restart: unless-stopped
    
    # Only start if Telegram is configured
    profiles:
      - telegram
    
    env_file:
      - ../.env
    
    environment:
      - TZ=UTC
    
    # Override command to run telegram bot
    command: ["python", "telegram_bot/telegram_notifier.py"]
    
    volumes:
      - bot-state:/app/state:ro
      - bot-simulation:/app/simulation:ro
    
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    networks:
      - polymarket-net
    
    depends_on:
      - bot

  # ===========================================================================
  # Live Dashboard (Optional)
  # ===========================================================================
  dashboard:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: polymarket-dashboard
    restart: unless-stopped
    
    profiles:
      - dashboard
    
    env_file:
      - ../.env
    
    command: ["python", "dashboard/live_dashboard.py"]
    
    volumes:
      - bot-state:/app/state:ro
      - bot-simulation:/app/simulation:ro
    
    # Expose dashboard port if web-based
    # ports:
    #   - "8080:8080"
    
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
    
    networks:
      - polymarket-net
    
    depends_on:
      - bot

# =============================================================================
# Named Volumes
# =============================================================================
volumes:
  bot-state:
    driver: local
    name: polymarket-state
  bot-logs:
    driver: local
    name: polymarket-logs
  bot-simulation:
    driver: local
    name: polymarket-simulation

# =============================================================================
# Networks
# =============================================================================
networks:
  polymarket-net:
    driver: bridge
    name: polymarket-network
